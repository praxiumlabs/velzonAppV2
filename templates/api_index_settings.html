{% extends "base.html" %}

{% block title %}API Index Settings - WordPress API Manager{% endblock %}

{% block extra_css %}
<style>
    .info-box {
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .info-box h3 {
        color: var(--accent-primary);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .info-box p {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .setup-steps {
        background: rgba(245, 158, 11, 0.05);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .setup-steps h3 {
        color: var(--warning);
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .setup-steps ol {
        color: var(--text-secondary);
        padding-left: 1.5rem;
    }

    .setup-steps li {
        margin-bottom: 0.75rem;
    }

    .setup-steps li strong {
        color: var(--text-primary);
    }

    .website-config {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: var(--bg-secondary);
    }

    .website-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .website-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .website-url {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .form-group textarea {
        width: 100%;
        min-height: 120px;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        font-family: 'Monaco', 'Courier New', monospace;
        transition: border-color 0.3s ease;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .form-group textarea:focus {
        outline: none;
        border-color: var(--accent-primary);
    }

    .form-group textarea::placeholder {
        color: var(--text-muted);
    }

    .btn-group {
        display: flex;
        gap: 0.75rem;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-dot.configured {
        background: var(--success);
    }

    .status-dot.not-configured {
        background: var(--error);
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    @media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
        }
        
        .website-header {
            flex-direction: column;
            align-items: start;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">API Index Settings</h1>
    <p class="page-subtitle">Configure Google Indexing API credentials for your websites</p>
</div>

<div class="info-box">
    <h3>Service Account Keys</h3>
    <p>Paste the JSON content of the Service Account Key file you downloaded from Google Cloud Console for each website. Ensure the service account has the "Owner" role for the corresponding property in Google Search Console and the Indexing API is enabled in Google Cloud.</p>
</div>

<div class="setup-steps">
    <h3>Setup Instructions</h3>
    <ol>
        <li><strong>Create Google Cloud Project:</strong> Go to Google Cloud Console and create a new project</li>
        <li><strong>Enable Indexing API:</strong> In APIs & Services > Library, search for and enable "Web Search Indexing API"</li>
        <li><strong>Create Service Account:</strong> Go to IAM & Admin > Service Accounts and create a new service account</li>
        <li><strong>Generate Key:</strong> Create a JSON key for the service account and download it</li>
        <li><strong>Add to Search Console:</strong> Add the service account email as an Owner in Google Search Console</li>
        <li><strong>Paste JSON Below:</strong> Copy the entire JSON content and paste it in the corresponding website field below</li>
    </ol>
</div>

<div class="card">
    <h2 class="card-title">Service Account Keys</h2>
    <div id="websitesList">
        <div class="empty-state">
            <div class="empty-state-icon">⚙️</div>
            <h3>No websites found</h3>
            <p>Please add a website first in the <a href="/manage-websites">Manage Websites</a> section.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.addEventListener('load', function() {
        loadWebsites();
    });

    async function loadWebsites() {
        try {
            const response = await fetch('/api/websites');
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    displayWebsiteSettings(result.websites);
                } else {
                    showEmptyState();
                }
            } else {
                showEmptyState();
            }
        } catch (error) {
            console.error('Failed to load websites:', error);
            showEmptyState();
        }
    }

    function displayWebsiteSettings(websites) {
        const websitesList = document.getElementById('websitesList');
        
        if (websites.length === 0) {
            showEmptyState();
            return;
        }

        websitesList.innerHTML = websites.map(website => `
            <div class="website-config">
                <div class="website-header">
                    <div>
                        <div class="website-title">${website.website_name}</div>
                        <div class="website-url">${website.website_url}</div>
                    </div>
                    <div class="status-indicator" id="status_${website.id}">
                        <div class="status-dot ${website.has_service_account ? 'configured' : 'not-configured'}"></div>
                        ${website.has_service_account ? 'Configured' : 'Not Configured'}
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="serviceAccount_${website.id}">Service Account Key (JSON Content)</label>
                    <textarea 
                        id="serviceAccount_${website.id}" 
                        placeholder="Paste your Google Service Account JSON content here..."
                    ></textarea>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="clearServiceAccount(${website.id}, this)">Clear Key</button>
                    <button type="button" class="btn btn-primary" onclick="updateServiceAccount(${website.id}, this)">Update Key</button>
                </div>
            </div>
        `).join('');
    }

    function showEmptyState() {
        const websitesList = document.getElementById('websitesList');
        websitesList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">⚙️</div>
                <h3>No websites found</h3>
                <p>Please add a website first in the <a href="/manage-websites">Manage Websites</a> section.</p>
            </div>
        `;
    }

    async function updateServiceAccount(websiteId, button) {
        const textarea = document.getElementById(`serviceAccount_${websiteId}`);
        const serviceAccountJson = textarea.value.trim();

        if (!serviceAccountJson) {
            showAlert('Please paste the Service Account JSON content.', 'error');
            return;
        }

        // Validate JSON
        try {
            JSON.parse(serviceAccountJson);
        } catch (e) {
            showAlert('Invalid JSON format. Please check your Service Account key.', 'error');
            return;
        }

        // Set loading state
        button.disabled = true;
        button.textContent = 'Updating...';

        try {
            const response = await fetch('/api/update-service-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    website_id: websiteId,
                    service_account_json: serviceAccountJson
                })
            });

            const result = await response.json();

            if (result.success) {
                showAlert('Service Account key updated successfully!', 'success');
                // Update status indicator
                const statusIndicator = document.getElementById(`status_${websiteId}`);
                if (statusIndicator) {
                    statusIndicator.innerHTML = `
                        <div class="status-dot configured"></div>
                        Configured
                    `;
                }
            } else {
                showAlert(result.message, 'error');
            }
        } catch (error) {
            showAlert('Connection error. Please try again.', 'error');
        } finally {
            // Reset button state
            button.disabled = false;
            button.textContent = 'Update Key';
        }
    }

    function clearServiceAccount(websiteId, button) {
        if (confirm('Are you sure you want to clear the Service Account key? This will disable Google Indexing API for this website.')) {
            const textarea = document.getElementById(`serviceAccount_${websiteId}`);
            textarea.value = '';
            
            // Update status indicator
            const statusIndicator = document.getElementById(`status_${websiteId}`);
            if (statusIndicator) {
                statusIndicator.innerHTML = `
                    <div class="status-dot not-configured"></div>
                    Not Configured
                `;
            }
            
            showAlert('Service Account key cleared.', 'warning');
        }
    }
</script>
{% endblock %}