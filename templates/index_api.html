{% extends "base.html" %}

{% block title %}Index API - WordPress API Manager{% endblock %}

{% block extra_css %}
<style>
    .info-box {
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .info-box h3 {
        color: var(--accent-primary);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .info-box p {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .results-section {
        margin-top: 2rem;
        display: none;
    }

    .result-item {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .result-url {
        font-weight: 600;
        color: var(--text-primary);
        word-break: break-all;
    }

    .result-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .result-status.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .result-status.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
    }

    .result-details {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .loading {
        display: none;
        text-align: center;
        color: var(--text-muted);
        margin-top: 1rem;
    }

    @media (max-width: 1024px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .result-header {
            flex-direction: column;
            align-items: start;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Index API</h1>
    <p class="page-subtitle">Submit URLs to Google for faster indexing</p>
</div>

<div class="info-box">
    <h3>Google Indexing API</h3>
    <p>Select a website, enter a single URL, choose the action, and submit it to the Google Indexing API. Ensure API settings are configured.</p>
</div>

<div class="card">
    <h2 class="card-title">Submit URL to Google</h2>
    <form id="indexingForm" onsubmit="submitIndexing(event)">
        <div class="form-grid">
            <div class="form-group">
                <label for="websiteSelect">Select Website *</label>
                <select id="websiteSelect" name="website_id" required>
                    <option value="">-- Select Website --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="urlInput">URL to Submit *</label>
                <input type="url" id="urlInput" name="url" placeholder="https://yourdomain.com/your-page-slug/" required>
            </div>

            <div class="form-group">
                <label for="actionSelect">Action *</label>
                <select id="actionSelect" name="action" required>
                    <option value="URL_UPDATED">URL Updated</option>
                    <option value="URL_DELETED">URL Deleted</option>
                </select>
            </div>
        </div>

        <button type="submit" class="btn btn-primary" id="submitBtn">Submit to Google</button>
        <div class="loading" id="submitLoading">Submitting to Google Indexing API...</div>
    </form>
</div>

<div id="resultsSection" class="results-section">
    <div class="card">
        <h2 class="card-title">Submission Results</h2>
        <div id="resultsContainer"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.addEventListener('load', function() {
        loadWebsites();
    });

    async function loadWebsites() {
        try {
            const response = await fetch('/api/websites');
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    const websiteSelect = document.getElementById('websiteSelect');
                    websiteSelect.innerHTML = '<option value="">-- Select Website --</option>';
                    
                    result.websites.forEach(website => {
                        const option = document.createElement('option');
                        option.value = website.id;
                        option.textContent = `${website.website_name} (${website.website_url})`;
                        websiteSelect.appendChild(option);
                    });

                    if (result.websites.length === 0) {
                        showAlert('Please add websites in Manage Websites section first.', 'info');
                    }
                }
            } else {
                showAlert('Failed to load websites. Please try refreshing the page.', 'error');
            }
        } catch (error) {
            console.error('Failed to load websites:', error);
            showAlert('Connection error while loading websites.', 'error');
        }
    }

    function setLoading(isLoading) {
        const btn = document.getElementById('submitBtn');
        const loading = document.getElementById('submitLoading');
        
        if (isLoading) {
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            loading.style.display = 'block';
        } else {
            btn.disabled = false;
            btn.textContent = 'Submit to Google';
            loading.style.display = 'none';
        }
    }

    async function submitIndexing(event) {
        event.preventDefault();
        setLoading(true);

        const formData = new FormData(event.target);
        const data = {
            website_id: formData.get('website_id'),
            url: formData.get('url'),
            action: formData.get('action')
        };

        try {
            const response = await fetch('/api/submit-indexing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('URL submitted successfully to Google Indexing API!', 'success');
                displayResult(data.url, data.action, 'success', result.result);
            } else {
                showAlert(`Submission failed: ${result.message}`, 'error');
                displayResult(data.url, data.action, 'error', result.message);
            }
        } catch (error) {
            showAlert('Connection error. Please try again.', 'error');
            displayResult(data.url, data.action, 'error', 'Connection error');
        } finally {
            setLoading(false);
        }
    }

    function displayResult(url, action, status, details) {
        const resultsSection = document.getElementById('resultsSection');
        const resultsContainer = document.getElementById('resultsContainer');
        
        // Show results section
        resultsSection.style.display = 'block';
        
        // Create result item
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
            <div class="result-header">
                <div class="result-url">${url}</div>
                <div class="result-status ${status}">${status}</div>
            </div>
            <div class="result-details">
                <strong>Action:</strong> ${action}<br>
                <strong>Time:</strong> ${new Date().toLocaleString()}<br>
                <strong>Details:</strong> ${typeof details === 'object' ? JSON.stringify(details, null, 2) : details}
            </div>
        `;
        
        // Add to top of results
        resultsContainer.insertBefore(resultItem, resultsContainer.firstChild);
        
        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}