{% extends "base.html" %}

{% block title %}Single Page Editor - WordPress API Manager{% endblock %}

{% block extra_css %}
<style>
    .workflow-steps {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .step-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        position: relative;
        transition: all 0.3s ease;
    }

    .step-card.active {
        border-color: var(--accent-primary);
        background: rgba(59, 130, 246, 0.05);
    }

    .step-card.completed {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.05);
    }

    .step-number {
        width: 48px;
        height: 48px;
        background: var(--border-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin: 0 auto 1rem;
        color: var(--text-muted);
        font-size: 1.25rem;
    }

    .step-card.active .step-number {
        background: var(--accent-primary);
        color: white;
    }

    .step-card.completed .step-number {
        background: var(--success);
        color: white;
    }

    .step-title {
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .step-description {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .content-preview {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .preview-title {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 1.25rem;
    }

    .preview-url {
        font-size: 0.875rem;
        color: var(--accent-primary);
        word-break: break-all;
    }

    .content-editor {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
    }

    .editor-tabs {
        display: flex;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .editor-tab {
        padding: 1rem 1.5rem;
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .editor-tab.active {
        background: var(--card-bg);
        color: var(--accent-primary);
        border-bottom: 2px solid var(--accent-primary);
    }

    .editor-content {
        padding: 2rem;
    }

    .editor-section {
        display: none;
    }

    .editor-section.active {
        display: block;
    }

    .seo-guidelines {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(124, 58, 237, 0.1));
        border: 1px solid var(--accent-primary);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .seo-guidelines h4 {
        color: var(--accent-primary);
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .seo-guidelines ul {
        font-size: 0.875rem;
        color: var(--text-secondary);
        padding-left: 1.5rem;
    }

    .seo-guidelines li {
        margin-bottom: 0.25rem;
    }

    .content-textarea {
        min-height: 300px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.9rem;
        resize: vertical;
    }

    .yoast-section {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1));
        border: 1px solid var(--success);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .yoast-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        color: var(--success);
        margin-bottom: 1rem;
        font-size: 1.125rem;
    }

    .yoast-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .btn-group {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }

    .loading {
        display: none;
        text-align: center;
        color: var(--text-muted);
        padding: 2rem;
    }

    .loading-spinner {
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--accent-primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .hidden {
        display: none;
    }

    @media (max-width: 1024px) {
        .form-grid,
        .yoast-grid,
        .workflow-steps {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
        }
        
        .editor-tabs {
            flex-wrap: wrap;
        }
        
        .editor-tab {
            flex: 1;
            min-width: 120px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Single Page Editor</h1>
    <p class="page-subtitle">Edit individual WordPress pages with advanced SEO optimization</p>
</div>

<div class="workflow-steps">
    <div class="step-card active" id="step1">
        <div class="step-number">1</div>
        <div class="step-title">Select & Fetch</div>
        <div class="step-description">Choose website and enter page URL</div>
    </div>
    <div class="step-card" id="step2">
        <div class="step-number">2</div>
        <div class="step-title">Edit Content</div>
        <div class="step-description">Optimize content and SEO settings</div>
    </div>
    <div class="step-card" id="step3">
        <div class="step-number">3</div>
        <div class="step-title">Publish</div>
        <div class="step-description">Save changes to WordPress</div>
    </div>
</div>

<!-- Step 1: Fetch Content -->
<div class="card" id="fetchSection">
    <h2 class="card-title">üîç Fetch Page Content</h2>
    <form id="fetchForm" onsubmit="fetchContent(event)">
        <div class="form-grid">
            <div class="form-group">
                <label for="websiteSelect">Select Website *</label>
                <select id="websiteSelect" name="website_id" required>
                    <option value="">-- Select Website --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="pageUrl">Page URL *</label>
                <input type="url" id="pageUrl" name="page_url" placeholder="https://yourdomain.com/your-page-slug/" required>
            </div>
        </div>

        <button type="submit" class="btn btn-primary" id="fetchBtn">
            üîç Fetch Content
        </button>
        
        <div class="loading" id="fetchLoading">
            <div class="loading-spinner"></div>
            <p>Fetching page content from WordPress...</p>
        </div>
    </form>
</div>

<!-- Step 2: Edit Content -->
<div class="card hidden" id="editSection">
    <h2 class="card-title">‚úèÔ∏è Edit Page Content</h2>
    
    <div class="content-preview">
        <div class="preview-header">
            <div class="preview-title" id="originalTitle">Page Title</div>
            <div class="preview-url" id="previewUrl">URL will appear here</div>
        </div>
    </div>

    <div class="content-editor">
        <div class="editor-tabs">
            <button class="editor-tab active" onclick="switchTab('content')">üìù Content</button>
            <button class="editor-tab" onclick="switchTab('seo')">üîç SEO Settings</button>
            <button class="editor-tab" onclick="switchTab('preview')">üëÄ Preview</button>
        </div>

        <div class="editor-content">
            <form id="editForm">
                <input type="hidden" id="postId" name="post_id">
                
                <!-- Content Tab -->
                <div id="contentTab" class="editor-section active">
                    <div class="seo-guidelines">
                        <h4>üìã SEO Content Guidelines</h4>
                        <ul>
                            <li><strong>Title:</strong> 50-60 characters, include primary keyword</li>
                            <li><strong>H1:</strong> One per page, unique and descriptive</li>
                            <li><strong>H2-H6:</strong> Logical hierarchy, break up content</li>
                            <li><strong>Images:</strong> Always include descriptive alt text</li>
                            <li><strong>Internal Links:</strong> Link to related content on your site</li>
                            <li><strong>Word Count:</strong> Aim for 300+ words for better SEO</li>
                        </ul>
                    </div>
                    
                    <div class="form-group">
                        <label for="pageTitle">Page Title *</label>
                        <input type="text" id="pageTitle" name="title" required>
                        <small style="color: var(--text-muted);">Character count: <span id="titleCount">0</span>/60</small>
                    </div>

                    <div class="form-group">
                        <label for="pageContent">Content (HTML)</label>
                        <textarea id="pageContent" name="content" class="content-textarea" placeholder="Enter your HTML content here. Use proper heading tags (H1, H2, H3) and include alt attributes for images."></textarea>
                        <small style="color: var(--text-muted);">Word count: <span id="wordCount">0</span> | Use HTML tags for formatting</small>
                    </div>
                </div>

                <!-- SEO Tab -->
                <div id="seoTab" class="editor-section">
                    <div class="yoast-section">
                        <div class="yoast-title">
                            üéØ Yoast SEO Optimization
                        </div>
                        
                        <div class="yoast-grid">
                            <div class="form-group">
                                <label for="seoTitle">SEO Title</label>
                                <input type="text" id="seoTitle" name="yoast_title" maxlength="60">
                                <small style="color: var(--text-muted);">Character count: <span id="seoTitleCount">0</span>/60</small>
                            </div>

                            <div class="form-group">
                                <label for="seoDescription">Meta Description</label>
                                <textarea id="seoDescription" name="yoast_description" rows="3" maxlength="160"></textarea>
                                <small style="color: var(--text-muted);">Character count: <span id="metaDescCount">0</span>/160</small>
                            </div>

                            <div class="form-group">
                                <label for="ogTitle">Open Graph Title</label>
                                <input type="text" id="ogTitle" name="og_title">
                                <small style="color: var(--text-muted);">For social media sharing</small>
                            </div>

                            <div class="form-group">
                                <label for="ogDescription">Open Graph Description</label>
                                <textarea id="ogDescription" name="og_description" rows="3"></textarea>
                                <small style="color: var(--text-muted);">Social media description</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Tab -->
                <div id="previewTab" class="editor-section">
                    <h3>üì± Content Preview</h3>
                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <div id="previewContent" style="color: var(--text-secondary);">
                            Select content tab and add content to see preview
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        üîÑ Reset Changes
                    </button>
                    <button type="submit" class="btn btn-success" id="updateBtn">
                        üöÄ Publish Changes
                    </button>
                </div>

                <div class="loading" id="updateLoading">
                    <div class="loading-spinner"></div>
                    <p>Publishing changes to WordPress...</p>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPostData = null;
    let currentWebsiteId = null;

    window.addEventListener('load', function() {
        loadWebsites();
        setupCharacterCounters();
        setupContentPreview();
    });

    async function loadWebsites() {
        try {
            const response = await fetch('/api/websites');
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    const websiteSelect = document.getElementById('websiteSelect');
                    websiteSelect.innerHTML = '<option value="">-- Select Website --</option>';
                    
                    result.websites.forEach(website => {
                        const option = document.createElement('option');
                        option.value = website.id;
                        option.textContent = `${website.website_name} (${website.website_url})`;
                        websiteSelect.appendChild(option);
                    });

                    if (result.websites.length === 0) {
                        showAlert('Please add websites in Manage Websites section first.', 'info');
                    }
                } else {
                    showAlert('Failed to load websites. Please add websites first.', 'warning');
                }
            }
        } catch (error) {
            console.error('Failed to load websites:', error);
            showAlert('Connection error while loading websites.', 'error');
        }
    }

    function setupCharacterCounters() {
        // Title counter
        document.getElementById('pageTitle').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('titleCount').textContent = count;
            document.getElementById('titleCount').style.color = count > 60 ? 'var(--error)' : 'var(--text-muted)';
        });

        // SEO Title counter  
        document.getElementById('seoTitle').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('seoTitleCount').textContent = count;
            document.getElementById('seoTitleCount').style.color = count > 60 ? 'var(--error)' : 'var(--text-muted)';
        });

        // Meta Description counter
        document.getElementById('seoDescription').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('metaDescCount').textContent = count;
            document.getElementById('metaDescCount').style.color = count > 160 ? 'var(--error)' : 'var(--text-muted)';
        });

        // Content word counter
        document.getElementById('pageContent').addEventListener('input', function() {
            const text = this.value.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            const wordCount = text ? text.split(' ').length : 0;
            document.getElementById('wordCount').textContent = wordCount;
            document.getElementById('wordCount').style.color = wordCount < 300 ? 'var(--warning)' : 'var(--success)';
            updatePreview();
        });
    }

    function setupContentPreview() {
        document.getElementById('pageTitle').addEventListener('input', updatePreview);
        document.getElementById('pageContent').addEventListener('input', updatePreview);
    }

    function updatePreview() {
        const title = document.getElementById('pageTitle').value;
        const content = document.getElementById('pageContent').value;
        const previewElement = document.getElementById('previewContent');
        
        let preview = '';
        if (title) preview += `<h1 style="color: var(--text-primary); margin-bottom: 1rem;">${title}</h1>`;
        if (content) preview += content;
        
        previewElement.innerHTML = preview || 'Add content to see preview';
    }

    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.editor-tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        // Update tab content
        document.querySelectorAll('.editor-section').forEach(section => section.classList.remove('active'));
        document.getElementById(tabName + 'Tab').classList.add('active');
    }

    function setStep(stepNumber) {
        // Update step indicators
        for (let i = 1; i <= 3; i++) {
            const stepCard = document.getElementById(`step${i}`);
            stepCard.classList.remove('active', 'completed');
            
            if (i < stepNumber) {
                stepCard.classList.add('completed');
            } else if (i === stepNumber) {
                stepCard.classList.add('active');
            }
        }
    }

    function setLoading(section, isLoading) {
        const button = section === 'fetch' ? document.getElementById('fetchBtn') : document.getElementById('updateBtn');
        const loading = section === 'fetch' ? document.getElementById('fetchLoading') : document.getElementById('updateLoading');
        
        if (isLoading) {
            button.disabled = true;
            loading.style.display = 'block';
        } else {
            button.disabled = false;
            loading.style.display = 'none';
        }
    }

    async function fetchContent(event) {
        event.preventDefault();
        setLoading('fetch', true);

        const formData = new FormData(event.target);
        const data = {
            website_id: formData.get('website_id'),
            post_url: formData.get('page_url')
        };

        currentWebsiteId = data.website_id;

        try {
            const response = await fetch('/api/fetch-post-content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                currentPostData = result.post_data;
                populateEditForm(result.post_data);
                showAlert('Content fetched successfully! üéâ', 'success');
                
                // Show edit section and update steps
                document.getElementById('editSection').classList.remove('hidden');
                setStep(2);
                
                // Scroll to edit section
                document.getElementById('editSection').scrollIntoView({ behavior: 'smooth' });
            } else {
                showAlert(result.message, 'error');
            }
        } catch (error) {
            showAlert('Connection error. Please try again.', 'error');
        } finally {
            setLoading('fetch', false);
        }
    }

    function populateEditForm(postData) {
        // Basic fields
        document.getElementById('postId').value = postData.id;
        document.getElementById('pageTitle').value = postData.title;
        document.getElementById('pageContent').value = postData.content;
        
        // Preview section
        document.getElementById('originalTitle').textContent = postData.title;
        document.getElementById('previewUrl').textContent = postData.slug || 'URL';
        
        // Yoast SEO fields
        if (postData.yoast) {
            document.getElementById('seoTitle').value = postData.yoast.title || '';
            document.getElementById('seoDescription').value = postData.yoast.description || '';
            document.getElementById('ogTitle').value = postData.yoast.og_title || '';
            document.getElementById('ogDescription').value = postData.yoast.og_description || '';
        }

        // Update counters
        ['pageTitle', 'seoTitle', 'seoDescription', 'pageContent'].forEach(id => {
            document.getElementById(id).dispatchEvent(new Event('input'));
        });
        
        updatePreview();
    }

    async function updateContent(event) {
        event.preventDefault();
        setLoading('update', true);

        const formData = new FormData(event.target);
        const updates = {
            title: formData.get('title'),
            content: formData.get('content'),
            yoast_head_json: {
                title: formData.get('yoast_title'),
                description: formData.get('yoast_description'),
                og_title: formData.get('og_title'),
                og_description: formData.get('og_description')
            }
        };

        const data = {
            website_id: currentWebsiteId,
            post_id: formData.get('post_id'),
            updates: updates
        };

        try {
            const response = await fetch('/api/update-post-content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('Page updated successfully! üöÄ', 'success');
                setStep(3);
            } else {
                showAlert(`Update failed: ${result.message}`, 'error');
            }
        } catch (error) {
            showAlert('Connection error. Please try again.', 'error');
        } finally {
            setLoading('update', false);
        }
    }

    function resetForm() {
        if (currentPostData && confirm('Are you sure you want to reset all changes? This will restore the original content.')) {
            populateEditForm(currentPostData);
            showAlert('Form reset to original content. üîÑ', 'info');
        }
    }

    // Add event listener for edit form
    document.getElementById('editForm').addEventListener('submit', updateContent);

    function showAlert(message, type = 'error') {
        const alert = document.getElementById('alert');
        alert.textContent = message;
        alert.className = `alert ${type}`;
        alert.style.display = 'block';
        
        setTimeout(() => {
            alert.style.display = 'none';
        }, 6000);
    }
</script>
{% endblock %}